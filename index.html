<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ã‚µã‚¤ãƒ³ãŠã¿ãã˜ (Alpine.jsç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=M+PLUS+Rounded+1c:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'M PLUS Rounded 1c', sans-serif;
        }
        .result-card {
            min-height: 288px;
        }
        .user-avatar {
            transition: all 0.2s ease-in-out;
        }
        .user-avatar:hover {
            transform: scale(1.1);
        }
        .winner-highlight {
            box-shadow: 0 0 30px 10px rgba(250, 204, 21, 0.7);
            transform: scale(1.1);
        }
        /* Alpine.jsãŒåˆæœŸåŒ–ã•ã‚Œã‚‹ã¾ã§è¦ç´ ã‚’éš ã™ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        [x-cloak] { display: none !important; }
    </style>

    <!-- Alpine.jsã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã‚’å…ˆã«å®šç¾©ã—ã¾ã™ -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('omikujiApp', () => ({
                // --- çŠ¶æ…‹ (State) ---
                users: [],
                newUserId: '',
                isSpinning: false,
                winner: null,
                rouletteUser: null, // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸­ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼

                // --- åˆæœŸåŒ–å‡¦ç† ---
                init() {
                    this.loadUsersFromHash();
                    // ãƒãƒƒã‚·ãƒ¥ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    window.addEventListener('hashchange', () => this.loadUsersFromHash());
                    // usersé…åˆ—ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã€è‡ªå‹•ã§ãƒãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                    this.$watch('users', () => this.saveUsersToHash());
                },

                // --- getter (ç®—å‡ºãƒ—ãƒ­ãƒ‘ãƒ†ã‚£) ---
                get rouletteAvatar() {
                    if (this.winner) return `https://github.com/${this.winner}.png`;
                    if (this.rouletteUser) return `https://github.com/${this.rouletteUser}.png`;
                    return 'https://placehold.co/128x128/e2e8f0/94a3b8?text=?';
                },
                get resultMessage() {
                    if (this.winner) {
                        return `<span class="font-bold text-indigo-600">${this.winner}</span> ã•ã‚“ã«æ±ºå®šï¼ğŸ‰`;
                    }
                    if (this.isSpinning) return 'é¸å®šä¸­...';
                    return 'èª°ãŒé¸ã°ã‚Œã‚‹ã‹ãªï¼Ÿ';
                },

                // --- ãƒ¡ã‚½ãƒƒãƒ‰ (Actions) ---
                loadUsersFromHash() {
                    const hash = window.location.hash.substring(1);
                    if (hash) {
                        const userIds = hash.split(',').filter(id => id.trim() !== '');
                        this.users = [...new Set(userIds)];
                    } else {
                        this.users = [];
                    }
                },
                saveUsersToHash() {
                    // è‹¥å¹²ã®é…å»¶ã‚’å…¥ã‚Œã¦ã€é€£ç¶šã—ãŸå¤‰æ›´ã‚’ä¸€åº¦ã«ã¾ã¨ã‚ã‚‹
                    setTimeout(() => {
                        window.location.hash = this.users.join(',');
                    }, 100);
                },
                addUser() {
                    const id = this.newUserId.trim();
                    if (id && !this.users.includes(id)) {
                        this.users.push(id);
                    }
                    this.newUserId = '';
                },
                removeUser(user) {
                    this.users = this.users.filter(u => u !== user);
                },
                startRoulette() {
                    if (this.isSpinning || this.users.length === 0) return;

                    this.isSpinning = true;
                    this.winner = null;
                    const finalWinner = this.users[Math.floor(Math.random() * this.users.length)];

                    let interval = 50;
                    let duration = 3000;
                    let spinCount = 0;

                    const spin = () => {
                        this.rouletteUser = this.users[Math.floor(Math.random() * this.users.length)];
                        
                        setTimeout(() => {
                            duration -= interval;
                            if (spinCount > 10) interval += spinCount;
                            if (spinCount > 20) interval += spinCount * 2;
                            
                            if (duration > 0) {
                                spinCount++;
                                spin();
                            } else {
                                this.endRoulette(finalWinner);
                            }
                        }, interval);
                    };
                    spin();
                },
                endRoulette(finalWinner) {
                    this.winner = finalWinner;
                    
                    // ç‚¹æ»…ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    const rouletteEl = document.getElementById('roulette');
                    let blinkCount = 0;
                    const maxBlinks = 6;
                    const blinkInterval = setInterval(() => {
                        rouletteEl.classList.toggle('opacity-50');
                        blinkCount++;
                        if (blinkCount >= maxBlinks) {
                            clearInterval(blinkInterval);
                            rouletteEl.classList.remove('opacity-50');
                            this.isSpinning = false;
                        }
                    }, 200);
                }
            }));
        });
    </script>

    <!-- Alpine.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ defer ã‚’ã¤ã‘ã¦èª­ã¿è¾¼ã¿ã¾ã™ -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col items-center justify-center min-h-screen p-4">

    <div 
        class="w-full max-w-2xl mx-auto"
        x-data="omikujiApp" 
        x-init="init()"
        x-cloak
    >
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-700" style="font-family: 'M PLUS Rounded 1c', sans-serif;">ã‚¢ã‚µã‚¤ãƒ³ãŠã¿ãã˜</h1>
            <p class="text-slate-500 mt-2">ä»Šæ—¥ã®æ‹…å½“è€…ã¯èª°ã‹ãªï¼Ÿ</p>
        </header>

        <main class="bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-8">
            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="result-card bg-slate-50 rounded-xl flex flex-col items-center justify-center text-center p-6 transition-all duration-300">
                <div id="roulette" class="flex flex-col items-center justify-center" :class="{ 'winner-highlight': winner }">
                    <img :src="rouletteAvatar" alt="çµæœ" class="w-32 h-32 rounded-full mb-4 object-cover bg-slate-200">
                    <p class="text-2xl font-bold text-slate-600">
                        <span x-html="resultMessage"></span>
                    </p>
                </div>
            </div>

            <!-- ã‚¢ã‚µã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
            <button 
                @click="startRoulette()"
                :disabled="users.length === 0 || isSpinning"
                class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg text-xl hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all duration-300 disabled:bg-slate-300 disabled:cursor-not-allowed shadow-md hover:shadow-lg disabled:shadow-none"
            >
                ã‚¢ã‚µã‚¤ãƒ³ï¼
            </button>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¨ãƒªã‚¢ -->
            <div class="border-t border-slate-200 pt-6">
                <h2 class="text-xl font-semibold mb-4 text-slate-600">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
                
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
                <form @submit.prevent="addUser()" class="flex flex-col sm:flex-row gap-3 mb-6">
                    <input type="text" x-model="newUserId" placeholder="GitHub ID ã‚’å…¥åŠ›" class="flex-grow w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 transition">
                    <button type="submit" class="bg-emerald-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-emerald-600 focus:outline-none focus:ring-4 focus:ring-emerald-300 transition shadow-sm hover:shadow-md">
                        è¿½åŠ 
                    </button>
                </form>

                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-slate-500">å‚åŠ è€…ãƒªã‚¹ãƒˆ</h3>
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4">
                        <!-- template x-forã§ãƒ¦ãƒ¼ã‚¶ãƒ¼é…åˆ—ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦æç”» -->
                        <template x-for="user in users" :key="user">
                            <div class="relative text-center group">
                                <img :src="`https://github.com/${user}.png`" 
                                     onerror="this.onerror=null; this.src='https://placehold.co/80x80/f1f5f9/94a3b8?text=NG';"
                                     :alt="user" 
                                     class="w-20 h-20 rounded-full mx-auto object-cover border-4 border-white shadow-md user-avatar">
                                <p class="text-sm mt-2 truncate font-medium text-slate-600" x-text="user"></p>
                                <button @click="removeUser(user)" class="delete-user-btn absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform -translate-y-1 translate-x-1 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400">
                                    Ã—
                                </button>
                            </div>
                        </template>
                    </div>
                     <p x-show="users.length === 0" class="text-center text-slate-400 py-4">ã¾ã èª°ã‚‚ã„ã¾ã›ã‚“ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-slate-400 text-sm">
            <p>ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã™ã‚‹ã¨å‚åŠ è€…ãƒªã‚¹ãƒˆã‚’ä¿å­˜ã§ãã¾ã™ã€‚</p>
        </footer>
    </div>
    <!-- ãƒ­ã‚¸ãƒƒã‚¯ã¯headã«ç§»å‹•ã—ãŸãŸã‚ã€bodyæœ«å°¾ã®scriptã‚¿ã‚°ã¯ä¸è¦ã§ã™ -->
</body>
</html>
