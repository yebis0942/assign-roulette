<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アサインルーレット</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin-left: auto;
            margin-right: auto;
            max-width: 50rem;
        }
        .result-card {
            min-height: 288px;
        }
        [x-cloak] { display: none !important; }
        .delete-user-btn {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .user-card:hover .delete-user-btn {
            opacity: 1;
        }
        
        .avatar {
            width: 128px;
            height: 128px;
            object-fit: cover;
            background-image: url('assets/empty_avatar.svg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        /* --- Roulette Styles --- */
        .roulette-wrapper {
            height: 128px;
            width: 128px;
            overflow: hidden;
            position: relative;
            border-radius: 50%;
            border: 4px solid #f8f9fa;
	        box-sizing: content-box;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .roulette-reel {
            display: flex;
            transition: transform 4.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .roulette-item {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .roulette-item img {
            width: 128px;
            height: 128px;
            object-fit: cover;
        }
        .winner-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 5px solid #0d6efd; /* Primary color */
            border-radius: 50%;
            box-sizing: border-box;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .winner-indicator.show {
            opacity: 1;
        }
    </style>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('omikujiApp', () => ({
                // --- 状態 (State) ---
                users: [],
                newUserId: '',
                isSpinning: false,
                winner: null,
                rouletteItems: [], // スクロール用配列

                // --- 初期化処理 ---
                init() {
                    this.loadUsersFromHash();
                    window.addEventListener('hashchange', () => this.loadUsersFromHash());
                    this.$watch('users', () => this.saveUsersToHash());
                    this.rouletteItems = [{ id: '?', avatar: 'assets/empty_avatar.svg' }];
                },

                // --- getter (算出プロパティ) ---
                get resultMessage() {
                    if (this.winner) {
                        return `<span class="fw-bold text-primary">${this.winner}</span>`;
                    }
                    if (this.isSpinning) return '選定中...';
                    if (this.users.length === 0) return 'メンバーを追加してスタート！';
		            return '';
                },

                // --- メソッド (Actions) ---
                loadUsersFromHash() {
                    const hash = window.location.hash.substring(1);
                    if (hash) {
                        const userIds = hash.split(',').filter(id => id.trim() !== '');
                        this.users = [...new Set(userIds)];
                    } else {
                        this.users = [];
                    }
                },
                saveUsersToHash() {
                    window.location.hash = this.users.join(',');
                },
                addUser() {
                    const id = this.newUserId.trim();
                    if (id && !this.users.includes(id)) {
                        this.users.push(id);
                    }
                    this.newUserId = '';
                },
                removeUser(user) {
                    this.users = this.users.filter(u => u !== user);
                },
                startRoulette() {
                    if (this.isSpinning || this.users.length === 0) return;

                    this.isSpinning = true;
                    this.winner = null;
                    const reelEl = this.$refs.reel;
                    
                    // 1. リールを準備
                    const REPEAT_COUNT = 10;
                    let tempReel = [];
                    for(let i = 0; i < REPEAT_COUNT; i++) {
                        const chunk = this.users.map(u => ({ id: u, avatar: `https://github.com/${u}.png` }));
                        
			            // Fisher-Yates shuffle
                        for (let i = chunk.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [chunk[i], chunk[j]] = [chunk[j], chunk[i]];
                        }

			            tempReel.push(...chunk);
                    }
                    
                    // 最終的な当選者をリールの最後の方から選ぶ
                    const winnerIndex = tempReel.length - Math.floor(Math.random() * this.users.length) - 1;
                    const finalWinner = tempReel[winnerIndex].id;
                    this.rouletteItems = tempReel;

                    // 2. アニメーション開始
                    this.$nextTick(() => {
                        // a. トランジションを一旦無効にして、リールを先頭にリセット
                        reelEl.style.transition = 'none';
                        reelEl.style.transform = 'translateX(0)';
                        
                        // b. 少し待ってからトランジションを有効にし、最終位置へ移動
                        setTimeout(() => {
                            const iconWidth = 128;
                            const offset = winnerIndex * iconWidth;
                            reelEl.style.transition = 'transform 4.5s cubic-bezier(0.25, 0.1, 0.25, 1)';
                            reelEl.style.transform = `translateX(-${offset}px)`;
                        }, 20); 
                    });

                    // 3. アニメーション終了処理
                    setTimeout(() => {
                        this.endRoulette(finalWinner);
                    }, 4800); // transitionの時間 + α
                },
                endRoulette(finalWinner) {
                    this.winner = finalWinner;
                    this.isSpinning = false;
                }
            }));
        });
    </script>

    <!-- Alpine.jsライブラリを defer をつけて読み込みます -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-light d-flex flex-column min-vh-100">
    <div 
        class="container my-5"
        x-data="omikujiApp" 
        x-init="init()"
        x-cloak
    >
        
        <header class="text-center mb-5">
            <h1 class="display-4 fw-bold text-secondary">アサインルーレット</h1>
        </header>

        <main class="bg-white rounded shadow p-4 p-md-5 mb-5">
            <!-- 結果表示エリア -->
            <div class="result-card bg-light rounded d-flex flex-column align-items-center justify-content-center text-center p-4 mb-4">
                <div id="roulette" class="d-flex flex-column align-items-center justify-content-center">
                    <!-- Roulette Viewport -->
                    <div class="roulette-wrapper mb-4">
                        <div class="winner-indicator" :class="{ 'show': winner && !isSpinning }"></div>
                        <div x-ref="reel" class="roulette-reel">
                            <!-- Reel Items -->
                            <template x-for="(item, index) in rouletteItems" :key="index">
                                <div class="roulette-item">
                                    <img :src="item.avatar" class="avatar">
                                </div>
                            </template>
                        </div>
                    </div>
                    <p class="h3 fw-bold text-secondary" style="min-height: 2rem;">
                        <span x-html="resultMessage"></span>
                    </p>
                </div>
            </div>

            <!-- スタートボタン -->
            <button 
                @click="startRoulette()"
                :disabled="users.length === 0 || isSpinning"
                class="w-100 btn btn-primary btn-lg fw-bold shadow"
                :class="{'disabled': users.length === 0 || isSpinning}"
            >
                スタート
            </button>

            <!-- メンバー管理エリア -->
            <div class="border-top border-light pt-5 mt-5">
                <h2 class="h3 fw-semibold mb-4 text-secondary">メンバー</h2>
                
                <!-- メンバー追加フォーム -->
                <form @submit.prevent="addUser()" class="row row-cols-lg-auto g-3 align-items-center mb-5">
                    <div class="flex-grow-1">
                        <input type="text" x-model="newUserId" placeholder="GitHub ID を入力" class="form-control form-control-lg">
                    </div>
                    <div>
                        <button type="submit" class="btn btn-success btn-lg fw-semibold">
                            追加
                        </button>
                    </div>
                </form>

                <!-- メンバー一覧 -->
                <div>
                    <div class="row row-cols-3 row-cols-sm-4 row-cols-md-6 g-4">
                        <template x-for="user in users" :key="user">
                            <div class="col">
                                <div class="text-center position-relative user-card">
                                    <img :src="`https://github.com/${user}.png`" 
                                         class="rounded-circle mx-auto d-block shadow avatar" style="width: 80px; height: 80px; object-fit: cover; border: 4px solid white;">
                                    <p class="text-muted mt-2 mb-0 text-truncate fw-medium" x-text="user"></p>
                                    <button @click="removeUser(user)" class="delete-user-btn position-absolute top-0 start-100 translate-middle bg-danger text-white rounded-circle border-0" style="width: 24px; height: 24px;">
                                        ×
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                     <p x-show="users.length === 0" class="text-center text-muted py-4">メンバーを追加してください。</p>
                </div>
            </div>
        </main>
        
        <footer class="text-center text-muted mt-auto">
            <p class="small mb-0">ブックマークすると現在の設定を保存できます。</p>
        </footer>
    </div>
    
    <!-- Bootstrap 5 JS (Optional, for some components) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
