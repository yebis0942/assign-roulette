<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アサインルーレット</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin-left: auto;
            margin-right: auto;
            max-width: 50rem;
        }
        .result-card {
            min-height: 288px;
        }
        [x-cloak] { display: none !important; }
        .delete-user-btn {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .user-card:hover .delete-user-btn {
            opacity: 1;
        }
        #roulette.blink {
            opacity: 0.5;
        }
    </style>

    <script>
        document.addEventListener('alpine:init', () => {
            // https://placehold.co/128x128/e2e8f0/94a3b8?text=?
            const emptyAvatar = 'data:text/plain;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22128%22%20height%3D%22128%22%20viewBox%3D%220%200%20128%20128%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23e2e8f0%22%2F%3E%3Cpath%20fill%3D%22%2394a3b8%22%20d%3D%22m53.745%2048.385-2.08-3.3q1.09-.96%202.39-1.82%201.29-.87%202.8-1.51%201.5-.64%203.26-1.01%201.76-.36%203.81-.36%202.78%200%205.07.76%202.29.77%203.92%202.2%201.63%201.42%202.53%203.44.89%202.01.89%204.51%200%202.43-.7%204.21-.7%201.77-1.76%203.08-1.06%201.32-2.32%202.28t-2.38%201.8q-1.12.85-1.94%201.67-.82.81-.98%201.84l-.73%204.67h-5.41l-.54-5.22q-.2-1.5.43-2.64.62-1.13%201.66-2.08%201.04-.94%202.32-1.82t2.4-1.92%201.87-2.34q.76-1.29.76-3.08%200-1.16-.44-2.07-.43-.91-1.2-1.57-.76-.65-1.84-1-1.07-.36-2.32-.36-1.82%200-3.08.4-1.27.4-2.15.9t-1.49.9q-.6.4-1.08.4-1.16%200-1.67-.96m3.97%2034.43q0-.99.37-1.89t1.01-1.54%201.53-1.02q.9-.38%201.92-.38%201.03%200%201.91.38t1.53%201.02q.66.64%201.04%201.54.39.9.39%201.89%200%201.02-.39%201.9-.38.88-1.04%201.52-.65.64-1.53%201.01t-1.91.37q-1.02%200-1.92-.37-.89-.37-1.53-1.01t-1.01-1.52-.37-1.9%22%2F%3E%3C%2Fsvg%3E';

            Alpine.data('omikujiApp', () => ({
                // --- 状態 (State) ---
                users: [],
                newUserId: '',
                isSpinning: false,
                winner: null,
                rouletteUser: null, // ルーレット中に表示されるユーザー

                // --- 初期化処理 ---
                init() {
                    this.loadUsersFromHash();
                    // ハッシュの変更を監視して、データを再読み込み
                    window.addEventListener('hashchange', () => this.loadUsersFromHash());
                    // users配列が変更されたら、自動でハッシュを更新
                    this.$watch('users', () => this.saveUsersToHash());
                },

                // --- getter (算出プロパティ) ---
                get rouletteAvatar() {
                    if (this.winner) return `https://github.com/${this.winner}.png`;
                    if (this.rouletteUser) return `https://github.com/${this.rouletteUser}.png`;
                    return emptyAvatar;
                },
                get resultMessage() {
                    if (this.winner) {
                        return `<span class="fw-bold text-primary">${this.winner}</span>`;
                    }
                    if (this.isSpinning) return '選定中...';
                    return null;
                },

                // --- メソッド (Actions) ---
                loadUsersFromHash() {
                    const hash = window.location.hash.substring(1);
                    if (hash) {
                        const userIds = hash.split(',').filter(id => id.trim() !== '');
                        this.users = [...new Set(userIds)];
                    } else {
                        this.users = [];
                    }
                },
                saveUsersToHash() {
                    window.location.hash = this.users.join(',');
                },
                addUser() {
                    const id = this.newUserId.trim();
                    if (id && !this.users.includes(id)) {
                        this.users.push(id);
                    }
                    this.newUserId = '';
                },
                removeUser(user) {
                    this.users = this.users.filter(u => u !== user);
                },
                startRoulette() {
                    if (this.isSpinning || this.users.length === 0) return;

                    this.isSpinning = true;
                    this.winner = null;
                    const finalWinner = this.users[Math.floor(Math.random() * this.users.length)];

                    let interval = 1;
                    let duration = 4500;
                    let spinCount = 0;

                    const spin = () => {
                        this.rouletteUser = this.users[Math.floor(Math.random() * this.users.length)];
                        
                        setTimeout(() => {
                            duration -= interval;
                            interval = Math.min(80, interval + spinCount);
                            
                            if (duration > 0) {
                                spinCount++;
                                spin();
                            } else {
                                this.endRoulette(finalWinner);
                            }
                        }, interval);
                    };
                    spin();
                },
                endRoulette(finalWinner) {
                    this.winner = finalWinner;
                    
                    // 点滅エフェクト
                    const rouletteEl = document.getElementById('roulette');
                    let blinkCount = 0;
                    const maxBlinks = 6;
                    const blinkInterval = setInterval(() => {
                        rouletteEl.classList.toggle('blink');
                        blinkCount++;
                        if (blinkCount >= maxBlinks) {
                            clearInterval(blinkInterval);
                            rouletteEl.classList.remove('blink');
                            this.isSpinning = false;
                        }
                    }, 200);
                }
            }));
        });
    </script>

    <!-- Alpine.jsライブラリを defer をつけて読み込みます -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-light d-flex flex-column min-vh-100">

    <div 
        class="container my-5"
        x-data="omikujiApp" 
        x-init="init()"
        x-cloak
    >
        
        <header class="text-center mb-5">
            <h1 class="display-4 fw-bold text-secondary">アサインルーレット</h1>
        </header>

        <main class="bg-white rounded shadow p-4 p-md-5 mb-5">
            <!-- 結果表示エリア -->
            <div class="result-card bg-light rounded d-flex flex-column align-items-center justify-content-center text-center p-4 mb-4">
                <div id="roulette" class="d-flex flex-column align-items-center justify-content-center">
                    <img :src="rouletteAvatar" alt="結果" class="rounded-circle mb-4 bg-secondary" style="width: 128px; height: 128px; object-fit: cover;">
                    <p class="h3 fw-bold text-secondary">
                        <span x-html="resultMessage"></span>
                    </p>
                </div>
            </div>

            <!-- スタートボタン -->
            <button 
                @click="startRoulette()"
                :disabled="users.length === 0 || isSpinning"
                class="w-100 btn btn-primary btn-lg fw-bold shadow"
                :class="{'disabled': users.length === 0 || isSpinning}"
            >
                スタート
            </button>

            <!-- メンバー管理エリア -->
            <div class="border-top border-light pt-5 mt-5">
                <h2 class="h3 fw-semibold mb-4 text-secondary">メンバー</h2>
                
                <!-- メンバー追加フォーム -->
                <form @submit.prevent="addUser()" class="row g-3 mb-5">
                    <div class="col-md-9">
                        <input type="text" x-model="newUserId" placeholder="GitHub ID を入力" class="form-control form-control-lg">
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="w-100 btn btn-success btn-lg fw-semibold">
                            追加
                        </button>
                    </div>
                </form>

                <!-- メンバー一覧 -->
                <div>
                    <div class="row row-cols-3 row-cols-sm-4 row-cols-md-6 g-4">
                        <!-- template x-forでメンバー配列をループして描画 -->
                        <template x-for="user in users" :key="user">
                            <div class="col">
                                <div class="text-center position-relative user-card">
                                    <img :src="`https://github.com/${user}.png`" 
                                         onerror="this.onerror=null; this.src='https://placehold.co/80x80/f8f9fa/6c757d?text=NG';"
                                         :alt="user" 
                                         class="rounded-circle mx-auto d-block shadow" style="width: 80px; height: 80px; object-fit: cover; border: 4px solid white;">
                                    <p class="text-muted mt-2 mb-0 text-truncate fw-medium" x-text="user"></p>
                                    <button @click="removeUser(user)" class="delete-user-btn position-absolute top-0 start-100 translate-middle bg-danger text-white rounded-circle border-0" style="width: 24px; height: 24px;">
                                        ×
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                     <p x-show="users.length === 0" class="text-center text-muted py-4">メンバーを追加してください。</p>
                </div>
            </div>
        </main>
        
        <footer class="text-center text-muted mt-auto">
            <p class="small mb-0">ブックマークすると現在の設定を保存できます。</p>
        </footer>
    </div>
    
    <!-- Bootstrap 5 JS (Optional, for some components) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>