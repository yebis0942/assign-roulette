<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アサインおみくじ (Alpine.js版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=M+PLUS+Rounded+1c:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'M PLUS Rounded 1c', sans-serif;
        }
        .result-card {
            min-height: 288px;
        }
        .user-avatar {
            transition: all 0.2s ease-in-out;
        }
        .user-avatar:hover {
            transform: scale(1.1);
        }
        .winner-highlight {
            box-shadow: 0 0 30px 10px rgba(250, 204, 21, 0.7);
            transform: scale(1.1);
        }
        /* Alpine.jsが初期化されるまで要素を隠すためのスタイル */
        [x-cloak] { display: none !important; }
    </style>

    <!-- Alpine.jsのコンポーネントロジックを先に定義します -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('omikujiApp', () => ({
                // --- 状態 (State) ---
                users: [],
                newUserId: '',
                isSpinning: false,
                winner: null,
                rouletteUser: null, // ルーレット中に表示されるユーザー

                // --- 初期化処理 ---
                init() {
                    this.loadUsersFromHash();
                    // ハッシュの変更を監視して、データを再読み込み
                    window.addEventListener('hashchange', () => this.loadUsersFromHash());
                    // users配列が変更されたら、自動でハッシュを更新
                    this.$watch('users', () => this.saveUsersToHash());
                },

                // --- getter (算出プロパティ) ---
                get rouletteAvatar() {
                    if (this.winner) return `https://github.com/${this.winner}.png`;
                    if (this.rouletteUser) return `https://github.com/${this.rouletteUser}.png`;
                    return 'https://placehold.co/128x128/e2e8f0/94a3b8?text=?';
                },
                get resultMessage() {
                    if (this.winner) {
                        return `<span class="font-bold text-indigo-600">${this.winner}</span> さんに決定！🎉`;
                    }
                    if (this.isSpinning) return '選定中...';
                    return '誰が選ばれるかな？';
                },

                // --- メソッド (Actions) ---
                loadUsersFromHash() {
                    const hash = window.location.hash.substring(1);
                    if (hash) {
                        const userIds = hash.split(',').filter(id => id.trim() !== '');
                        this.users = [...new Set(userIds)];
                    } else {
                        this.users = [];
                    }
                },
                saveUsersToHash() {
                    // 若干の遅延を入れて、連続した変更を一度にまとめる
                    setTimeout(() => {
                        window.location.hash = this.users.join(',');
                    }, 100);
                },
                addUser() {
                    const id = this.newUserId.trim();
                    if (id && !this.users.includes(id)) {
                        this.users.push(id);
                    }
                    this.newUserId = '';
                },
                removeUser(user) {
                    this.users = this.users.filter(u => u !== user);
                },
                startRoulette() {
                    if (this.isSpinning || this.users.length === 0) return;

                    this.isSpinning = true;
                    this.winner = null;
                    const finalWinner = this.users[Math.floor(Math.random() * this.users.length)];

                    let interval = 50;
                    let duration = 3000;
                    let spinCount = 0;

                    const spin = () => {
                        this.rouletteUser = this.users[Math.floor(Math.random() * this.users.length)];
                        
                        setTimeout(() => {
                            duration -= interval;
                            if (spinCount > 10) interval += spinCount;
                            if (spinCount > 20) interval += spinCount * 2;
                            
                            if (duration > 0) {
                                spinCount++;
                                spin();
                            } else {
                                this.endRoulette(finalWinner);
                            }
                        }, interval);
                    };
                    spin();
                },
                endRoulette(finalWinner) {
                    this.winner = finalWinner;
                    
                    // 点滅エフェクト
                    const rouletteEl = document.getElementById('roulette');
                    let blinkCount = 0;
                    const maxBlinks = 6;
                    const blinkInterval = setInterval(() => {
                        rouletteEl.classList.toggle('opacity-50');
                        blinkCount++;
                        if (blinkCount >= maxBlinks) {
                            clearInterval(blinkInterval);
                            rouletteEl.classList.remove('opacity-50');
                            this.isSpinning = false;
                        }
                    }, 200);
                }
            }));
        });
    </script>

    <!-- Alpine.jsライブラリを defer をつけて読み込みます -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col items-center justify-center min-h-screen p-4">

    <div 
        class="w-full max-w-2xl mx-auto"
        x-data="omikujiApp" 
        x-init="init()"
        x-cloak
    >
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-700" style="font-family: 'M PLUS Rounded 1c', sans-serif;">アサインおみくじ</h1>
            <p class="text-slate-500 mt-2">今日の担当者は誰かな？</p>
        </header>

        <main class="bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-8">
            <!-- 結果表示エリア -->
            <div class="result-card bg-slate-50 rounded-xl flex flex-col items-center justify-center text-center p-6 transition-all duration-300">
                <div id="roulette" class="flex flex-col items-center justify-center" :class="{ 'winner-highlight': winner }">
                    <img :src="rouletteAvatar" alt="結果" class="w-32 h-32 rounded-full mb-4 object-cover bg-slate-200">
                    <p class="text-2xl font-bold text-slate-600">
                        <span x-html="resultMessage"></span>
                    </p>
                </div>
            </div>

            <!-- アサインボタン -->
            <button 
                @click="startRoulette()"
                :disabled="users.length === 0 || isSpinning"
                class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg text-xl hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all duration-300 disabled:bg-slate-300 disabled:cursor-not-allowed shadow-md hover:shadow-lg disabled:shadow-none"
            >
                アサイン！
            </button>

            <!-- ユーザー管理エリア -->
            <div class="border-t border-slate-200 pt-6">
                <h2 class="text-xl font-semibold mb-4 text-slate-600">ユーザー管理</h2>
                
                <!-- ユーザー追加フォーム -->
                <form @submit.prevent="addUser()" class="flex flex-col sm:flex-row gap-3 mb-6">
                    <input type="text" x-model="newUserId" placeholder="GitHub ID を入力" class="flex-grow w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 transition">
                    <button type="submit" class="bg-emerald-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-emerald-600 focus:outline-none focus:ring-4 focus:ring-emerald-300 transition shadow-sm hover:shadow-md">
                        追加
                    </button>
                </form>

                <!-- ユーザー一覧 -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-slate-500">参加者リスト</h3>
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4">
                        <!-- template x-forでユーザー配列をループして描画 -->
                        <template x-for="user in users" :key="user">
                            <div class="relative text-center group">
                                <img :src="`https://github.com/${user}.png`" 
                                     onerror="this.onerror=null; this.src='https://placehold.co/80x80/f1f5f9/94a3b8?text=NG';"
                                     :alt="user" 
                                     class="w-20 h-20 rounded-full mx-auto object-cover border-4 border-white shadow-md user-avatar">
                                <p class="text-sm mt-2 truncate font-medium text-slate-600" x-text="user"></p>
                                <button @click="removeUser(user)" class="delete-user-btn absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform -translate-y-1 translate-x-1 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400">
                                    ×
                                </button>
                            </div>
                        </template>
                    </div>
                     <p x-show="users.length === 0" class="text-center text-slate-400 py-4">まだ誰もいません。ユーザーを追加してください。</p>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-slate-400 text-sm">
            <p>ブックマークすると参加者リストを保存できます。</p>
        </footer>
    </div>
    <!-- ロジックはheadに移動したため、body末尾のscriptタグは不要です -->
</body>
</html>
